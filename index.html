<script>
  function showSection(id) {
    document.querySelectorAll('section').forEach(sec=>{
      sec.classList.remove('active');
      sec.style.display = 'none';
    });
    const target = document.getElementById(id);
    target.style.display = 'block';
    setTimeout(()=>target.classList.add('active'),10);
    window.scrollTo({top:0, behavior:'smooth'});
  }

  function toggleSearch() {
    const input = document.querySelector('.search-input');
    const results = document.querySelector('.search-results');

    if (input.style.display === 'block') {
      input.style.display = 'none';
      results.style.display = 'none';
    } else {
      input.style.display = 'block';
      input.focus();
    }
  }

  function resetHighlights() {
    document.querySelectorAll('section *').forEach(el=>{
      if (el.innerHTML) el.innerHTML = el.innerHTML.replace(/<mark>|<\/mark>/g,'');
    });
  }

  function searchContent(query) {
    resetHighlights();
    const resultsBox = document.querySelector('.search-results');
    resultsBox.innerHTML = '';
    if (!query.trim()) { resultsBox.style.display = 'none'; return; }

    let results = [];
    document.querySelectorAll('section').forEach(sec => {
      sec.querySelectorAll('*').forEach(el=>{
        if (el.innerText && el.innerText.toLowerCase().includes(query.toLowerCase())) {
          const regex = new RegExp(query, "gi");
          const match = el.innerText.match(regex);
          if (match) {
            results.push({ section: sec.id, keyword: match[0] });
          }
        }
      });
    });

    if (results.length === 0) {
      resultsBox.innerHTML = '<div>No results found</div>';
    } else {
      results = [...new Map(results.map(r => [r.keyword.toLowerCase(), r])).values()];
      results.slice(0,5).forEach(r => {
        const div = document.createElement('div');
        div.innerText = r.keyword;
        div.onclick = () => {
          showSection(r.section);
          setTimeout(()=>highlightAndScroll(r.keyword),500);
          resultsBox.style.display = 'none';
          document.querySelector('.search-input').style.display = 'none';
        };
        resultsBox.appendChild(div);
      });
    }
    resultsBox.style.display = 'block';
  }

  function highlightAndScroll(keyword) {
    const regex = new RegExp(`(${keyword})`, 'gi');
    let firstMark = null;
    document.querySelectorAll('section.active *').forEach(el => {
      if (el.innerHTML) {
        el.innerHTML = el.innerHTML.replace(regex,'<mark>$1</mark>');
        if (!firstMark) firstMark = el.querySelector('mark');
      }
    });
    if (firstMark) firstMark.scrollIntoView({behavior:'smooth', block:'center'});
  }

  // ðŸ‘‡ ThÃªm Ä‘oáº¡n nÃ y Ä‘á»ƒ click ra ngoÃ i thÃ¬ áº©n search
  document.addEventListener('click', function(event) {
    const searchContainer = document.querySelector('.search-container');
    const searchInput = document.querySelector('.search-input');
    const searchResults = document.querySelector('.search-results');
    if (!searchContainer.contains(event.target)) {
      searchInput.style.display = 'none';
      searchResults.style.display = 'none';
    }
  });
</script>
